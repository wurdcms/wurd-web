!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).wurd=e()}(this,(function(){"use strict";function t(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function e(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?t(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function o(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function i(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var a=function(){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,t),this.rawContent=n,this.storageKey=o.storageKey||"wurdContent",this.ttl=null!==(e=o.ttl)&&void 0!==e?e:36e5}return o(t,[{key:"get",value:function(t){return t?t.split(".").reduce((function(t,e){return t&&t[e]}),this.rawContent):this.rawContent}},{key:"load",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.lang,n=this.rawContent,o=this.storageKey,i=this.ttl;try{var a=JSON.parse(localStorage.getItem(o)),c=a&&a._wurd;return!a||!c||c.savedAt+i<Date.now()||(c.lang!==r||(delete a._wurd,Object.assign(n,a))),n}catch(t){return console.error("Wurd: error loading cache:",t),n}}},{key:"save",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.lang,o=this.rawContent,i=this.storageKey;Object.assign(o,t),localStorage.setItem(i,JSON.stringify(e(e({},o),{},{_wurd:{savedAt:Date.now(),lang:n}})))}},{key:"clear",value:function(){localStorage.removeItem(this.storageKey)}}]),t}(),c=function(){function t(e,n){var o=this;r(this,t),this.wurd=e,this.path=n,this._get=e.store.get.bind(e.store),Object.getOwnPropertyNames(Object.getPrototypeOf(this)).forEach((function(t){o[t]=o[t].bind(o)}))}return o(t,[{key:"id",value:function(t){return t?this.path?[this.path,t].join("."):t:this.path}},{key:"get",value:function(t){var e=this._get(this.id(t));if(void 0===e&&this.wurd.draft){var r=t.split(".")[0];this._get(r)||console.warn("Tried to access unloaded section: ".concat(r))}return e}},{key:"text",value:function(t,e){var r=this.get(t);return void 0===r?this.wurd.draft?"[".concat(t,"]"):"":"string"!=typeof r?(console.warn("Tried to get object as string: ".concat(t)),this.wurd.draft?"[".concat(t,"]"):""):(e&&(r=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"!=typeof t?t:t.replace(/{{([\w.-]+)}}/g,(function(t,r){return e[r]||""}))}(r,e)),r)}},{key:"markdown",value:function(t,e,r){var n=this.wurd.markdown,o=n.parse,i=n.parseInline,a=this.text(t,e);return null!=r&&r.inline&&i?i(a):o?o(a):a}},{key:"map",value:function(t,e){var r=this,n=this.get(t)||i({},Date.now(),{}),o=0;return Object.keys(n).sort().map((function(n){var i=o;o++;var a=[t,n].join("."),c=r.block(a);return e.call(void 0,c,i)}))}},{key:"block",value:function(e,r){var n=this.id(e),o=new t(this.wurd,n);return"function"==typeof r?r.call(void 0,o):o}},{key:"el",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=this.id(t),o=r.markdown?this.markdown(t,e):this.text(t,e),i=e||r.markdown?"data-wurd-md":"data-wurd";if(this.wurd.draft){var a=r.type||"span";return r.markdown&&(a="div"),"<".concat(a," ").concat(i,'="').concat(n,'">').concat(o,"</").concat(a,">")}return o}}]),t}(),s=function(){function t(e){var n=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,t),this.widgetUrl="https://widget.wurd.io/widget.js",this.apiUrl="https://api.wurd.io",this.store=new a,this.content=new c(this,null);var i=Object.getOwnPropertyNames(Object.getPrototypeOf(this.content));i.forEach((function(t){n[t]=n.content[t].bind(n.content)})),this.connect(e,o)}return o(t,[{key:"connect",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.app=t,this.draft=!1,this.editMode=!1,["draft","lang","markdown","debug","onLoad"].forEach((function(t){var n=r[t];void 0!==n&&(e[t]=n)})),r.editMode){case!0:this.startEditor();break;case"querystring":/[?&]edit(&|$)/.test(location.search)&&this.startEditor()}return r.rawContent&&this.store.save(r.rawContent,{lang:r.lang}),r.storageKey&&(this.store.storageKey=r.storageKey),r.ttl&&(this.store.ttl=r.ttl),r.blockHelpers&&this.setBlockHelpers(r.blockHelpers),this}},{key:"load",value:function(t){var e=this.app,r=this.store,n=this.lang,o=this.editMode,i=this.debug,a=this.onLoad,c=this.content;if(!e)return Promise.reject(new Error("Use wurd.connect(appName) before wurd.load()"));var s="string"==typeof t?t.split(","):t;if(o)return this._fetchSections(s).then((function(t){return r.save(t,{lang:n}),r.clear(),a&&a(c),c}));var u=r.load(s,{lang:n}),l=s.filter((function(t){return void 0===u[t]}));return i&&console.info("Wurd: from cache:",s.filter((function(t){return void 0!==u[t]}))),0===l.length?(a&&a(c),Promise.resolve(c)):this._fetchSections(l).then((function(t){return r.save(t,{lang:n}),a&&a(c),c}))}},{key:"_fetchSections",value:function(t){var e=this,r=this.app;this.debug&&console.info("Wurd: from server:",t);var n,o=["draft","lang"].reduce((function(t,r){return e[r]&&(t[r]=e[r]),t}),{}),i="".concat(this.apiUrl,"/apps/").concat(r,"/content/").concat(t,"?").concat((n=o,Object.keys(n).map((function(t){var e=n[t];return encodeURIComponent(t)+"="+encodeURIComponent(e)})).join("&")));return this._fetch(i).then((function(e){if(e.error)throw e.error.message?new Error(e.error.message):new Error("Error loading ".concat(t));return e}))}},{key:"_fetch",value:function(t){return fetch(t).then((function(e){if(!e.ok)throw new Error("Error loading ".concat(t,": ").concat(e.statusText));return e.json()}))}},{key:"startEditor",value:function(){var t=this.app,e=this.lang;this.editMode=!0,this.draft=!0;var r=document.createElement("script");r.src=this.widgetUrl,r.async=!0,r.setAttribute("data-app",t),e&&r.setAttribute("data-lang",e);var n=document.body.querySelector('script[src="'.concat(this.widgetUrl,'"]'));n&&document.body.removeChild(n),document.body.appendChild(r)}},{key:"setBlockHelpers",value:function(t){Object.assign(c.prototype,t)}}]),t}(),u=new s;return u.Wurd=s,u}));
