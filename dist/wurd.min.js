!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("marked")):"function"==typeof define&&define.amd?define(["marked"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).wurd=e(t.marked)}(this,(function(t){"use strict";function e(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function r(t){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?e(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function i(t,e,r){return e&&o(t.prototype,e),r&&o(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function a(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var c=function(){function t(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t),this.rawContent=r,this.storageKey=o.storageKey||"cmsContent",this.maxAge=null!==(e=o.maxAge)&&void 0!==e?e:36e5}return i(t,[{key:"get",value:function(t){return t?t.split(".").reduce((function(t,e){return t&&t[e]}),this.rawContent):this.rawContent}},{key:"load",value:function(){try{var t=JSON.parse(localStorage.getItem(this.storageKey));return!t||!t._expiry||t._expiry<Date.now()?this.rawContent:r(r({},t),this.rawContent)}catch(t){return console.error("Wurd: error loading cache:",t),this.rawContent}}},{key:"set",value:function(t){Object.assign(this.rawContent,t),localStorage.setItem(this.storageKey,JSON.stringify(r(r({},this.rawContent),{},{_expiry:Date.now()+this.maxAge})))}}]),t}(),s=function(){function e(t,r){var o=this;n(this,e),this.wurd=t,this.path=r,this._get=t.store.get.bind(t.store),Object.getOwnPropertyNames(Object.getPrototypeOf(this)).forEach((function(t){o[t]=o[t].bind(o)}))}return i(e,[{key:"id",value:function(t){return t?this.path?[this.path,t].join("."):t:this.path}},{key:"get",value:function(t){var e=this._get(this.id(t));if(void 0===e&&this.wurd.draft){var r=t.split(".")[0];this._get(r)||console.warn("Tried to access unloaded section: ".concat(r))}return e}},{key:"text",value:function(t,e){var r=this.get(t);return void 0===r?this.wurd.draft?"[".concat(t,"]"):"":"string"!=typeof r?(console.warn("Tried to get object as string: ".concat(t)),this.wurd.draft?"[".concat(t,"]"):""):(e&&(r=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"!=typeof t?t:t.replace(/{{([\w.-]+)}}/g,(function(t,r){return e[r]||""}))}(r,e)),r)}},{key:"markdown",value:function(e,r,n){var o=this.text(e,r);return null!=n&&n.inline&&t.marked.parseInline?t.marked.parseInline(o):t.marked.parse(o)}},{key:"map",value:function(t,e){var r=this,n=this.get(t)||a({},Date.now(),{}),o=0;return Object.keys(n).sort().map((function(n){var i=o;o++;var a=[t,n].join("."),c=r.block(a);return e.call(void 0,c,i)}))}},{key:"block",value:function(t,r){var n=this.id(t),o=new e(this.wurd,n);return"function"==typeof r?r.call(void 0,o):o}},{key:"el",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=this.id(t),o=r.markdown?this.markdown(t,e):this.text(t,e),i=e||r.markdown?"data-wurd-md":"data-wurd";if(this.wurd.draft){var a=r.type||"span";return r.markdown&&(a="div"),"<".concat(a," ").concat(i,'="').concat(n,'">').concat(o,"</").concat(a,">")}return o}}]),e}(),u="https://widget.wurd.io/widget.js",d=function(){function t(e,r){var o=this;n(this,t),this.store=new c(r&&r.storageKey),this.content=new s(this,null),Object.getOwnPropertyNames(Object.getPrototypeOf(this.content)).forEach((function(t){o[t]=o.content[t].bind(o.content)})),this.connect(e,r)}return i(t,[{key:"connect",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.app=t,this.draft=!1,this.editMode=!1,["draft","lang","debug"].forEach((function(t){var n=r[t];void 0!==n&&(e[t]=n)})),r.editMode){case!0:this.startEditor();break;case"querystring":/[?&]edit(&|$)/.test(location.search)&&this.startEditor()}return r.rawContent&&this.store.set(r.rawContent),r.blockHelpers&&this.setBlockHelpers(r.blockHelpers),this}},{key:"load",value:function(t){var e=this,r=this.app,n=this.store,o=this.editMode,i=this.debug;if(!r)return Promise.reject(new Error("Use wurd.connect(appName) before wurd.load()"));var a="string"==typeof t?t.split(","):t,c=n.load(),s=a.filter((function(t){return void 0===c[t]}));return i&&console.info("Wurd: from cache:",a.filter((function(t){return void 0!==c[t]}))),o||0!==s.length?(i&&console.info("Wurd: from server:",s),this._fetchSections(s).then((function(t){return n.set(t),e.content}))):Promise.resolve(this.content)}},{key:"_fetchSections",value:function(t){var e,r=this,n=this.app,o=["draft","lang"].reduce((function(t,e){return r[e]&&(t[e]=r[e]),t}),{}),i="".concat("https://api.wurd.io","/apps/").concat(n,"/content/").concat(t,"?").concat((e=o,Object.keys(e).map((function(t){var r=e[t];return encodeURIComponent(t)+"="+encodeURIComponent(r)})).join("&")));return this._fetch(i).then((function(e){if(e.error)throw e.error.message?new Error(e.error.message):new Error("Error loading ".concat(t));return e}))}},{key:"_fetch",value:function(t){return fetch(t).then((function(e){if(!e.ok)throw new Error("Error loading ".concat(t,": ").concat(e.statusText));return e.json()}))}},{key:"startEditor",value:function(){var t=this.app,e=this.lang;this.editMode=!0,this.draft=!0;var r=document.createElement("script");r.src=u,r.async=!0,r.setAttribute("data-app",t),e&&r.setAttribute("data-lang",e);var n=document.body.querySelector('script[src="'.concat(u,'"]'));n&&document.body.removeChild(n),document.body.appendChild(r)}},{key:"setBlockHelpers",value:function(t){Object.assign(s.prototype,t)}}]),t}(),f=new d;return f.Wurd=d,f}));
