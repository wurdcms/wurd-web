!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).wurd=e()}(this,(function(){"use strict";function t(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function e(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?t(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):t(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function o(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var a=function(){function t(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t),this.rawContent=r,this.storageKey=o.storageKey||"wurdContent",this.ttl=null!==(e=o.ttl)&&void 0!==e?e:36e5}return o(t,[{key:"get",value:function(t){return t?t.split(".").reduce((function(t,e){return t&&t[e]}),this.rawContent):this.rawContent}},{key:"load",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.lang,r=this.rawContent,o=this.storageKey,i=this.ttl;try{var a=JSON.parse(localStorage.getItem(o)),c=a&&a._wurd;return!a||!c||c.savedAt+i<Date.now()||(c.lang!==n||(delete a._wurd,Object.assign(r,a))),r}catch(t){return console.error("Wurd: error loading cache:",t),r}}},{key:"save",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.lang,o=this.rawContent,i=this.storageKey;Object.assign(o,t),localStorage.setItem(i,JSON.stringify(e(e({},o),{},{_wurd:{savedAt:Date.now(),lang:r}})))}},{key:"clear",value:function(){localStorage.removeItem(this.storageKey)}}]),t}(),c=function(){function t(e,r){var o=this;n(this,t),this.wurd=e,this.path=r,this._get=e.store.get.bind(e.store),Object.getOwnPropertyNames(Object.getPrototypeOf(this)).forEach((function(t){o[t]=o[t].bind(o)}))}return o(t,[{key:"id",value:function(t){return t?this.path?[this.path,t].join("."):t:this.path}},{key:"get",value:function(t){var e=this._get(this.id(t));if(void 0===e&&this.wurd.draft){var n=t.split(".")[0];this._get(n)||console.warn("Tried to access unloaded section: ".concat(n))}return e}},{key:"text",value:function(t,e){var n=this.get(t);return void 0===n?this.wurd.draft?"[".concat(t,"]"):"":"string"!=typeof n?(console.warn("Tried to get object as string: ".concat(t)),this.wurd.draft?"[".concat(t,"]"):""):(e&&(n=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"!=typeof t?t:t.replace(/{{([\w.-]+)}}/g,(function(t,n){return e[n]||""}))}(n,e)),n)}},{key:"markdown",value:function(t,e,n){var r=this.wurd.markdown,o=r.parse,i=r.parseInline,a=this.text(t,e);return null!=n&&n.inline&&i?i(a):o?o(a):a}},{key:"map",value:function(t,e){var n=this,r=this.get(t)||i({},Date.now(),{}),o=0;return Object.keys(r).sort().map((function(r){var i=o;o++;var a=[t,r].join("."),c=n.block(a);return e.call(void 0,c,i)}))}},{key:"block",value:function(e,n){var r=this.id(e),o=new t(this.wurd,r);return"function"==typeof n?n.call(void 0,o):o}},{key:"el",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this.id(t),o=n.markdown?this.markdown(t,e):this.text(t,e),i=e||n.markdown?"data-wurd-md":"data-wurd";if(this.wurd.draft){var a=n.type||"span";return n.markdown&&(a="div"),"<".concat(a," ").concat(i,'="').concat(r,'">').concat(o,"</").concat(a,">")}return o}}]),t}(),s="https://widget.wurd.io/widget.js",u=function(){function t(e){var r=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t),this.store=new a,this.content=new c(this,null);var i=Object.getOwnPropertyNames(Object.getPrototypeOf(this.content));i.forEach((function(t){r[t]=r.content[t].bind(r.content)})),this.connect(e,o)}return o(t,[{key:"connect",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.app=t,this.draft=!1,this.editMode=!1,["draft","lang","markdown","debug","onLoad"].forEach((function(t){var r=n[t];void 0!==r&&(e[t]=r)})),n.editMode){case!0:this.startEditor();break;case"querystring":/[?&]edit(&|$)/.test(location.search)&&this.startEditor()}return n.rawContent&&this.store.save(n.rawContent,{lang:n.lang}),n.storageKey&&(this.store.storageKey=n.storageKey),n.ttl&&(this.store.ttl=n.ttl),n.blockHelpers&&this.setBlockHelpers(n.blockHelpers),this}},{key:"load",value:function(t){var e=this,n=this.app,r=this.store,o=this.lang,i=this.editMode,a=this.debug;if(!n)return Promise.reject(new Error("Use wurd.connect(appName) before wurd.load()"));var c="string"==typeof t?t.split(","):t;if(i)return this._fetchSections(c).then((function(t){return r.save(t,{lang:o}),r.clear(),e.content}));var s=r.load(c,{lang:o}),u=c.filter((function(t){return void 0===s[t]}));return a&&console.info("Wurd: from cache:",c.filter((function(t){return void 0!==s[t]}))),0===u.length?Promise.resolve(this.content):this._fetchSections(u).then((function(t){return r.save(t,{lang:o}),e.onLoad&&e.onLoad(e.content),e.content}))}},{key:"_fetchSections",value:function(t){var e=this,n=this.app;this.debug&&console.info("Wurd: from server:",t);var r,o=["draft","lang"].reduce((function(t,n){return e[n]&&(t[n]=e[n]),t}),{}),i="".concat("https://api.wurd.io","/apps/").concat(n,"/content/").concat(t,"?").concat((r=o,Object.keys(r).map((function(t){var e=r[t];return encodeURIComponent(t)+"="+encodeURIComponent(e)})).join("&")));return this._fetch(i).then((function(e){if(e.error)throw e.error.message?new Error(e.error.message):new Error("Error loading ".concat(t));return e}))}},{key:"_fetch",value:function(t){return fetch(t).then((function(e){if(!e.ok)throw new Error("Error loading ".concat(t,": ").concat(e.statusText));return e.json()}))}},{key:"startEditor",value:function(){var t=this.app,e=this.lang;this.editMode=!0,this.draft=!0;var n=document.createElement("script");n.src=s,n.async=!0,n.setAttribute("data-app",t),e&&n.setAttribute("data-lang",e);var r=document.body.querySelector('script[src="'.concat(s,'"]'));r&&document.body.removeChild(r),document.body.appendChild(n)}},{key:"setBlockHelpers",value:function(t){Object.assign(c.prototype,t)}}]),t}(),l=new u;return l.Wurd=u,l}));
