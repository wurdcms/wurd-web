!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("marked")):"function"==typeof define&&define.amd?define(["marked"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).wurd=e(t.marked)}(this,(function(t){"use strict";function e(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function n(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach((function(e){a(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function i(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function a(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var c=function(){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,t),this.rawContent=n,this.storageKey=o.storageKey||"cmsContent",this.maxAge=null!==(e=o.maxAge)&&void 0!==e?e:36e5}return i(t,[{key:"get",value:function(t){return t?t.split(".").reduce((function(t,e){return t&&t[e]}),this.rawContent):this.rawContent}},{key:"set",value:function(t){return Object.assign(this.rawContent||{},t)}},{key:"load",value:function(){try{var t=JSON.parse(localStorage.getItem(this.storageKey));return!t||!t._expiry||t._expiry<Date.now()||(this.rawContent=t),this.rawContent}catch(t){return console.error("Wurd: error loading cache:",t),this.rawContent}}},{key:"save",value:function(){localStorage.setItem(this.storageKey,JSON.stringify(n(n({},this.rawContent),{},{_expiry:Date.now()+this.maxAge})))}}]),t}(),s=function(){function e(t,n){var o=this;r(this,e),this.wurd=t,this.path=n,this._get=t.store.get.bind(t.store),Object.getOwnPropertyNames(Object.getPrototypeOf(this)).forEach((function(t){o[t]=o[t].bind(o)}))}return i(e,[{key:"id",value:function(t){return t?this.path?[this.path,t].join("."):t:this.path}},{key:"get",value:function(t){var e=this._get(this.id(t));if(void 0===e&&this.wurd.draft){var n=t.split(".")[0];this._get(n)||console.warn("Tried to access unloaded section: ".concat(n))}return e}},{key:"text",value:function(t,e){var n=this.get(t);return void 0===n?this.wurd.draft?"[".concat(t,"]"):"":"string"!=typeof n?(console.warn("Tried to get object as string: ".concat(t)),this.wurd.draft?"[".concat(t,"]"):""):(e&&(n=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"!=typeof t?t:t.replace(/{{([\w.-]+)}}/g,(function(t,n){return e[n]||""}))}(n,e)),n)}},{key:"markdown",value:function(e,n,r){var o=this.text(e,n);return null!=r&&r.inline&&t.marked.parseInline?t.marked.parseInline(o):t.marked.parse(o)}},{key:"map",value:function(t,e){var n=this,r=this.get(t)||a({},Date.now(),{}),o=0;return Object.keys(r).sort().map((function(r){var i=o;o++;var a=[t,r].join("."),c=n.block(a);return e.call(void 0,c,i)}))}},{key:"block",value:function(t,n){var r=this.id(t),o=new e(this.wurd,r);return"function"==typeof n?n.call(void 0,o):o}},{key:"el",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this.id(t),o=n.markdown?this.markdown(t,e):this.text(t,e),i=e||n.markdown?"data-wurd-md":"data-wurd";if(this.wurd.draft){var a=n.type||"span";return n.markdown&&(a="div"),"<".concat(a," ").concat(i,'="').concat(r,'">').concat(o,"</").concat(a,">")}return o}}]),e}(),u="https://widget.wurd.io/widget.js",d=function(){function t(e,n){var o=this;r(this,t),this.store=new c(n&&n.storageKey),this.content=new s(this,null),Object.getOwnPropertyNames(Object.getPrototypeOf(this.content)).forEach((function(t){o[t]=o.content[t].bind(o.content)})),this.connect(e,n)}return i(t,[{key:"connect",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.app=t,this.draft=!1,this.editMode=!1,["draft","lang","debug"].forEach((function(t){var r=n[t];void 0!==r&&(e[t]=r)})),n.editMode){case!0:this.startEditor();break;case"querystring":/[?&]edit(&|$)/.test(location.search)&&this.startEditor()}return n.rawContent&&this.store.set(n.rawContent),n.blockHelpers&&this.setBlockHelpers(n.blockHelpers),this}},{key:"load",value:function(t){var e=this,n=this.app,r=this.store,o=this.editMode,i=this.debug;if(!n)return Promise.reject(new Error("Use wurd.connect(appName) before wurd.load()"));var a="string"==typeof t?t.split(","):t,c=r.load(),s=c?a.filter((function(t){return void 0===c[t]})):a;return i&&console.info("Wurd: from cache:",a.filter((function(t){return void 0!==(null==c?void 0:c[t])}))),o||0!==s.length?(i&&console.info("Wurd: from server:",s),this._fetchSections(s).then((function(t){return r.set(t),r.save(),e.content}))):Promise.resolve(this.content)}},{key:"_fetchSections",value:function(t){var e,n=this,r=this.app,o=["draft","lang"].reduce((function(t,e){return n[e]&&(t[e]=n[e]),t}),{}),i="".concat("https://api.wurd.io","/apps/").concat(r,"/content/").concat(t,"?").concat((e=o,Object.keys(e).map((function(t){var n=e[t];return encodeURIComponent(t)+"="+encodeURIComponent(n)})).join("&")));return this._fetch(i).then((function(e){if(e.error)throw e.error.message?new Error(e.error.message):new Error("Error loading ".concat(t));return e}))}},{key:"_fetch",value:function(t){return fetch(t).then((function(e){if(!e.ok)throw new Error("Error loading ".concat(t,": ").concat(e.statusText));return e.json()}))}},{key:"startEditor",value:function(){var t=this.app,e=this.lang;this.editMode=!0,this.draft=!0;var n=document.createElement("script");n.src=u,n.async=!0,n.setAttribute("data-app",t),e&&n.setAttribute("data-lang",e);var r=document.body.querySelector('script[src="'.concat(u,'"]'));r&&document.body.removeChild(r),document.body.appendChild(n)}},{key:"setBlockHelpers",value:function(t){Object.assign(s.prototype,t)}}]),t}(),f=new d;return f.Wurd=d,f}));
